"use client"

import { useEffect } from "react"
import { useRouter } from "next/navigation"
import api from "@/lib/api"

// –®–∞–±–ª–æ–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const welcomeContent = {
  blocks: [
    {
      type: "header",
      data: {
        text: "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –≤–∞—à–µ —Ä–∞–±–æ—á–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ!",
        level: 3
      }
    },
    {
      type: "paragraph",
      data: {
        text: "–≠—Ç–æ –≤–∞—à –ø–µ—Ä–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç. –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å —Å–≤–æ–∏ –º—ã—Å–ª–∏, –∑–∞–¥–∞—á–∏ –∏ –ø—Ä–æ–µ–∫—Ç—ã."
      }
    },
    {
      type: "header",
      data: {
        text: "‚ú® –ö–∞–∫ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É",
        level: 4
      }
    },
    {
      type: "list",
      data: {
        style: "unordered",
        items: [
          "–ù–∞–∂–º–∏—Ç–µ <kbd>/</kbd> –¥–ª—è –≤—ã–∑–æ–≤–∞ –º–µ–Ω—é –∫–æ–º–∞–Ω–¥",
          "–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏ –∏ —á–µ–∫-–ª–∏—Å—Ç—ã",
          "–î–æ–±–∞–≤–ª—è–π—Ç–µ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏",
          "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–≤–µ–∑–¥–æ—á–∫—É –≤ –≤–µ—Ä—Ö–Ω–µ–º –º–µ–Ω—é, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
        ]
      }
    },
    {
      type: "header",
      data: {
        text: "‚úÖ –í–∞—à–∏ –ø–µ—Ä–≤—ã–µ –∑–∞–¥–∞—á–∏",
        level: 4
      }
    },
    {
      type: "list",
      data: {
        style: "checklist",
        items: [
          "–ò–∑—É—á–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å",
          "–°–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –≤–ª–æ–∂–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç",
          "–î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ",
          "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–º —Å –∫–æ–ª–ª–µ–≥–æ–π"
        ]
      }
    },
    {
      type: "paragraph",
      data: {
        text: "–£–¥–∞—á–∏ –≤ —Ä–∞–±–æ—Ç–µ —Å –≤–∞—à–∏–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏! –ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏–ª–∏ –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏."
      }
    }
  ],
  time: new Date().getTime(),
  version: "2.27.0"
};

// –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π —Ñ–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
// –∏–∑ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
// @ts-ignore
let isCreatingRootDocument = window.isCreatingRootDocument || false;
// @ts-ignore
window.isCreatingRootDocument = isCreatingRootDocument;

export default function DocumentsIndexPage() {
  const router = useRouter()

  useEffect(() => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const token = localStorage.getItem("accessToken")
    
    if (!token) {
      // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
      router.push("/login")
      return
    }
    
    // –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç
    const fetchRootDocument = async () => {
      try {
        console.log("–ó–∞–ø—Ä–æ—Å –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã /documents...");
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç
        const response = await api.get("/documents/?root=true")
        console.log("–û—Ç–≤–µ—Ç API –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:", response.data)
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º
        let rootDocumentId = null;
        
        if (Array.isArray(response.data) && response.data.length > 0) {
          console.log(`–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${response.data.length} –∫–æ—Ä–Ω–µ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –≤—ã–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π`);
          
          // –°—Ç—Ä–æ–≥–æ–µ –ø—Ä–∞–≤–∏–ª–æ: –≤—Å–µ–≥–¥–∞ –≤—ã–±–∏—Ä–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç —Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º ID (—Å–∞–º—ã–π –ø–µ—Ä–≤—ã–π —Å–æ–∑–¥–∞–Ω–Ω—ã–π) 
          const sortedDocs = [...response.data].sort((a, b) => {
            const idA = parseInt(a.id);
            const idB = parseInt(b.id);
            return idA - idB;  // –û—Ç –º–µ–Ω—å—à–µ–≥–æ –∫ –±–æ–ª—å—à–µ–º—É
          });
          
          rootDocumentId = sortedDocs[0].id;
          console.log(`–í—ã–±—Ä–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç —Å ID ${rootDocumentId} –∫–∞–∫ —Å–∞–º—ã–π –ø–µ—Ä–≤—ã–π –∫–æ—Ä–Ω–µ–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç`);
        } else if (response.data && response.data.id) {
          // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞
          rootDocumentId = response.data.id;
          console.log(`–í—ã–±—Ä–∞–Ω –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ—Ä–Ω–µ–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç —Å ID ${rootDocumentId}`);
        }
        
        // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –Ω–µ–≥–æ
        if (rootDocumentId) {
          console.log(`–ü–µ—Ä–µ—Ö–æ–¥ –∫ –∫–æ—Ä–Ω–µ–≤–æ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É —Å ID ${rootDocumentId}`);
          router.push(`/documents/${rootDocumentId}`);
        } else {
          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –±–µ–∑ –≤—ã–±—Ä–∞—Å—ã–≤–∞–Ω–∏—è –æ—à–∏–±–∫–∏
          console.log("–ö–æ—Ä–Ω–µ–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π");
          await createRootDocument();
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:", err)
        // –ï—Å–ª–∏ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
        await createRootDocument();
      }
    }

    // –í—ã–¥–µ–ª—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    const createRootDocument = async () => {
      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
      if (isCreatingRootDocument) {
        console.log("–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –æ–∂–∏–¥–∞–µ–º...");
        // –ñ–¥–µ–º –Ω–µ–±–æ–ª—å—à–æ–µ –≤—Ä–µ–º—è –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—è–≤–∏–ª—Å—è –ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç
        await new Promise(resolve => setTimeout(resolve, 2000));
        const retryResponse = await api.get("/documents/?root=true");
        
        if (Array.isArray(retryResponse.data) && retryResponse.data.length > 0) {
          console.log("–î–æ–∫—É–º–µ–Ω—Ç –±—ã–ª —Å–æ–∑–¥–∞–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...");
          const sortedDocs = [...retryResponse.data].sort((a, b) => {
            const idA = parseInt(a.id);
            const idB = parseInt(b.id);
            return idA - idB;
          });
          
          const rootDocumentId = sortedDocs[0].id;
          router.push(`/documents/${rootDocumentId}`);
          return;
        }
        
        console.log("–î–æ–∫—É–º–µ–Ω—Ç –≤—Å–µ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω, –ø–æ–≤—Ç–æ—Ä—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É...");
        // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–µ —Å–æ–∑–¥–∞–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–ø—ã—Ç–∫—É —Å–æ–∑–¥–∞–Ω–∏—è
      }
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞—á–∞–ª—Å—è
      isCreatingRootDocument = true;
      // @ts-ignore
      window.isCreatingRootDocument = true;
      
      try {
        console.log("–°–æ–∑–¥–∞—é –Ω–æ–≤—ã–π –∫–æ—Ä–Ω–µ–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º");
        
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –∫–æ—Ä–Ω–µ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (—ç—Ç–æ –º–æ–∂–µ—Ç –æ–∑–Ω–∞—á–∞—Ç—å,
        // —á—Ç–æ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –≤–µ—Ä–Ω—É–ª–∏ –∏—Ö –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ)
        const checkResponse = await api.get("/documents/?root=true");
        if (Array.isArray(checkResponse.data) && checkResponse.data.length > 0) {
          console.log("–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ—Ä–Ω–µ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –æ—Ç–º–µ–Ω—è—é —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ");
          
          // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π (—Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º ID)
          const sortedDocs = [...checkResponse.data].sort((a, b) => {
            const idA = parseInt(a.id);
            const idB = parseInt(b.id);
            return idA - idB;
          });
          
          const rootDocumentId = sortedDocs[0].id;
          console.log(`–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç —Å ID ${rootDocumentId}`);
          router.push(`/documents/${rootDocumentId}`);
          return;
        }
        
        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è EditorJS –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        const documentData = {
          title: "–ú–æ—ë —Ä–∞–±–æ—á–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ",
          parent: null,
          is_root: true,
          content: welcomeContent
        };
        
        console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:", JSON.stringify(documentData, null, 2));
        
        const newRootResponse = await api.post("/documents/", documentData);
        
        console.log("–û—Ç–≤–µ—Ç API –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:", newRootResponse.data);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç id –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        if (newRootResponse.data && newRootResponse.data.id) {
          router.push(`/documents/${newRootResponse.data.id}`);
        } else {
          console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:", newRootResponse.data);
          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ—Ä–Ω–µ–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏.");
        }
      } catch (createErr) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:", createErr);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
      } finally {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        isCreatingRootDocument = false;
        // @ts-ignore
        window.isCreatingRootDocument = false;
      }
    }

    fetchRootDocument()
  }, [router])

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏, –ø–æ–∫–∞ –∏–¥–µ—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  return (
    <div className="flex flex-col items-center justify-center min-h-screen">
      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>
      <p className="text-lg text-muted-foreground">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞...</p>
    </div>
  )
} 